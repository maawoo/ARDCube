Bootstrap: debootstrap
MirrorURL: http://us.archive.ubuntu.com/ubuntu
OSVersion: bionic

%files 
    /home/marco/pypypy/ARDCube/ARDCube/singularity/snap /snap

%post -c /bin/bash

    ######### UBUNTU #########

    # https://github.com/mkandes/naked-singularity/blob/master/definition-files/ubuntu/Singularity.ubuntu-18.04

    # Set operating system mirror URL
    export MIRRORURL='http://us.archive.ubuntu.com/ubuntu'

    # Set operating system version
    export OSVERSION='bionic'

    # Set debian frontend interface
    export DEBIAN_FRONTEND='noninteractive'

    # Install system metapackages
    apt-get -y install ubuntu-standard
    apt-get -y install ubuntu-server

    # Add repositories
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION} main"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION} universe"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION} multiverse"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION} restricted"

    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-updates main"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-updates universe"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-updates multiverse"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-updates restricted"

    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-backports main"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-backports universe"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-backports multiverse"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-backports restricted"

    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-security main"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-security universe"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-security multiverse"
    add-apt-repository -y "deb ${MIRRORURL} ${OSVERSION}-security restricted"

    # Upgrade all software packages to their latest versions
    apt-get -y update && apt-get -y upgrade

    # Install some genereal packages
    apt-get install -y --no-install-recommends --no-install-suggests \
        build-essential \
        wget \
        zip \
        git \
        vim \
        locales \
        && apt-get autoremove -y \
        && apt-get clean -y

    # Set locale 
    locale-gen en_US.UTF-8
    export LANG=en_US.UTF-8
    export LANGUAGE=en_US:en
    export LC_ALL=en_US.UTF-8
    
    ######### SNAP #########

    # Create directory and c
    mkdir -p /src
    mv /snap /src/snap

    # SNAP wants the current folder '.' included in LD_LIBRARY_PATH
    export LD_LIBRARY_PATH=".:$LD_LIBRARY_PATH"

    # Install more packages
    apt-get install -y --no-install-recommends --no-install-suggests \
        libgfortran5 \
        python3 \
        python3-dev \
        python3-pip \
        python3-setuptools \
        default-jdk maven \
        && apt-get autoremove -y \
        && apt-get clean -y

    export JAVA_HOME="/usr/lib/jvm/java-11-openjdk-amd64/"
    update-alternatives --install /usr/bin/python python /usr/bin/python3 1

    # Install SNAP 
    bash /src/snap/install.sh

    # Test
    /usr/bin/python3 /src/snap/about.py

    update-alternatives --remove python /usr/bin/python3

    # Cleanup
    apt-get -y autoremove --purge
    apt-get -y clean
    rm -rf /src

%test

%environment

    export MIRRORURL='http://us.archive.ubuntu.com/ubuntu'
    export OSVERSION='bionic'
    export DEBIAN_FRONTEND='noninteractive'

    export LANGUAGE=en_US:en
    export LANG=en_US.UTF-8
    export LC_ALL=en_US.UTF-8

    export PATH="$PATH:/usr/local/snap/bin/:/root/.snap/auxdata/gdal/gdal-3-0-0/bin"
