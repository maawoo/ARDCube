# https://github.com/opendatacube/geobase
# https://github.com/opendatacube/cube-in-a-box

Bootstrap: docker
From: opendatacube/geobase:wheels-3.0.4
Stage: env_builder

%files
    ./requirements.txt /

%post -c /bin/bash
    mkdir -p /conf
    mv /requirements.txt /conf

    env-build-tool new /conf/requirements.txt /env /wheels


Bootstrap: docker
From: opendatacube/geobase:runner-3.0.4
Stage: final

%files from env_builder
    /env /env
    /bin/tini /bin/tini

%post
    mkdir /opt/notebooks
    chmod +x /bin/tini

%environment
    export GDAL_DATA=$(gdal-config --datadir)
    export LC_ALL=C.UTF-8
    export PATH="/env/bin:$PATH"

    export DB_HOSTNAME=postgres
    export DB_USERNAME=opendatacube
    export DB_PASSWORD=opendatacubepassword
    export DB_DATABASE=opendatacube

%startscript
    exec /bin/tini -s -- jupyter notebook --ip='0.0.0.0' --port=8888 --no-browser --allow-root --NotebookApp.token='secretpassword'

%runscript
    exec "$@"
